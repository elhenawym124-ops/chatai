const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function checkAIMessages() {
  try {
    console.log('ğŸ” ÙØ­Øµ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...');

    const conversationId = 'cmehrqu48009ruff8ec01mk8p';
    
    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const messages = await prisma.message.findMany({
      where: {
        conversationId: conversationId
      },
      orderBy: {
        createdAt: 'asc'
      }
    });

    console.log(`ğŸ“¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${messages.length}`);

    let customerMessages = 0;
    let aiMessages = 0;
    let manualMessages = 0;

    messages.forEach((msg, index) => {
      let isAiGenerated = false;
      
      if (msg.metadata) {
        try {
          const metadata = JSON.parse(msg.metadata);
          isAiGenerated = metadata.isAIGenerated || metadata.isAutoGenerated || false;
        } catch (e) {
          isAiGenerated = msg.metadata.includes('"isAIGenerated":true') || 
                         msg.metadata.includes('"isAutoGenerated":true');
        }
      }

      if (msg.isFromCustomer) {
        customerMessages++;
      } else if (isAiGenerated) {
        aiMessages++;
        console.log(`ğŸ¤– Ø±Ø³Ø§Ù„Ø© AI ${aiMessages}: "${msg.content.substring(0, 50)}..."`);
        if (msg.metadata) {
          try {
            const metadata = JSON.parse(msg.metadata);
            console.log(`   ğŸ“Š Ø§Ù„Ø«Ù‚Ø©: ${metadata.confidence || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
            console.log(`   ğŸ¯ Ø§Ù„Ù†ÙŠØ©: ${metadata.intent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
          } catch (e) {
            console.log(`   ğŸ“„ Metadata: ${msg.metadata.substring(0, 100)}...`);
          }
        }
      } else {
        manualMessages++;
      }
    });

    console.log('\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:');
    console.log(`   ğŸ‘¤ ${customerMessages} Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡`);
    console.log(`   ğŸ¤– ${aiMessages} Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ`);
    console.log(`   ğŸ‘¨â€ğŸ’¼ ${manualMessages} ÙŠØ¯ÙˆÙŠØ©`);

    // Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„Ù‡Ø§
    console.log('\nğŸ“ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„:');
    const lastMessages = messages.slice(-5);
    lastMessages.forEach((msg, index) => {
      let isAiGenerated = false;
      
      if (msg.metadata) {
        try {
          const metadata = JSON.parse(msg.metadata);
          isAiGenerated = metadata.isAIGenerated || metadata.isAutoGenerated || false;
        } catch (e) {
          isAiGenerated = msg.metadata.includes('"isAIGenerated":true') || 
                         msg.metadata.includes('"isAutoGenerated":true');
        }
      }

      const type = msg.isFromCustomer ? 'ğŸ‘¤ Ø¹Ù…ÙŠÙ„' : 
                   isAiGenerated ? 'ğŸ¤– Ø°ÙƒØ§Ø¡ ØµÙ†Ø§Ø¹ÙŠ' : 'ğŸ‘¨â€ğŸ’¼ ÙŠØ¯ÙˆÙŠ';
      
      console.log(`${index + 1}. ${type}: "${msg.content.substring(0, 60)}..."`);
      console.log(`   ğŸ“… ${msg.createdAt.toLocaleString('ar-EG')}`);
      if (msg.metadata && !msg.isFromCustomer) {
        console.log(`   ğŸ“„ Has metadata: ${!!msg.metadata}`);
      }
    });

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
  } finally {
    await prisma.$disconnect();
  }
}

checkAIMessages();
