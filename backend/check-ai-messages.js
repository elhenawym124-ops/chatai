const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function checkAIMessages() {
  try {
    console.log('🔍 فحص رسائل الذكاء الصناعي في المحادثة...');

    const conversationId = 'cmehrqu48009ruff8ec01mk8p';
    
    // جلب جميع الرسائل
    const messages = await prisma.message.findMany({
      where: {
        conversationId: conversationId
      },
      orderBy: {
        createdAt: 'asc'
      }
    });

    console.log(`📨 إجمالي الرسائل: ${messages.length}`);

    let customerMessages = 0;
    let aiMessages = 0;
    let manualMessages = 0;

    messages.forEach((msg, index) => {
      let isAiGenerated = false;
      
      if (msg.metadata) {
        try {
          const metadata = JSON.parse(msg.metadata);
          isAiGenerated = metadata.isAIGenerated || metadata.isAutoGenerated || false;
        } catch (e) {
          isAiGenerated = msg.metadata.includes('"isAIGenerated":true') || 
                         msg.metadata.includes('"isAutoGenerated":true');
        }
      }

      if (msg.isFromCustomer) {
        customerMessages++;
      } else if (isAiGenerated) {
        aiMessages++;
        console.log(`🤖 رسالة AI ${aiMessages}: "${msg.content.substring(0, 50)}..."`);
        if (msg.metadata) {
          try {
            const metadata = JSON.parse(msg.metadata);
            console.log(`   📊 الثقة: ${metadata.confidence || 'غير محدد'}`);
            console.log(`   🎯 النية: ${metadata.intent || 'غير محدد'}`);
          } catch (e) {
            console.log(`   📄 Metadata: ${msg.metadata.substring(0, 100)}...`);
          }
        }
      } else {
        manualMessages++;
      }
    });

    console.log('\n📊 الإحصائيات النهائية:');
    console.log(`   👤 ${customerMessages} من العملاء`);
    console.log(`   🤖 ${aiMessages} من الذكاء الصناعي`);
    console.log(`   👨‍💼 ${manualMessages} يدوية`);

    // عرض آخر 5 رسائل مع تفاصيلها
    console.log('\n📝 آخر 5 رسائل:');
    const lastMessages = messages.slice(-5);
    lastMessages.forEach((msg, index) => {
      let isAiGenerated = false;
      
      if (msg.metadata) {
        try {
          const metadata = JSON.parse(msg.metadata);
          isAiGenerated = metadata.isAIGenerated || metadata.isAutoGenerated || false;
        } catch (e) {
          isAiGenerated = msg.metadata.includes('"isAIGenerated":true') || 
                         msg.metadata.includes('"isAutoGenerated":true');
        }
      }

      const type = msg.isFromCustomer ? '👤 عميل' : 
                   isAiGenerated ? '🤖 ذكاء صناعي' : '👨‍💼 يدوي';
      
      console.log(`${index + 1}. ${type}: "${msg.content.substring(0, 60)}..."`);
      console.log(`   📅 ${msg.createdAt.toLocaleString('ar-EG')}`);
      if (msg.metadata && !msg.isFromCustomer) {
        console.log(`   📄 Has metadata: ${!!msg.metadata}`);
      }
    });

  } catch (error) {
    console.error('❌ خطأ في فحص الرسائل:', error);
  } finally {
    await prisma.$disconnect();
  }
}

checkAIMessages();
