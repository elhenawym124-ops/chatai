const { PrismaClient } = require('@prisma/client');

async function testGeminiGeneralQuestions() {
  const prisma = new PrismaClient();
  
  try {
    console.log('ğŸ” Testing Gemini General Product Questions...\n');
    
    const companyId = 'cmd5c0c9y0000ymzdd7wtv7ib';
    
    // Test general questions that should show available products
    const generalQuestions = [
      'Ø¹Ù†Ø¯ÙƒÙ… Ù…Ù†ØªØ¬Ø§Øª Ø¥ÙŠÙ‡ØŸ',
      'Ø¥ÙŠÙ‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©ØŸ',
      'Ø¹Ø§ÙŠØ² Ø£Ø´ÙˆÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
      'Ø¹Ù†Ø¯ÙƒÙ… Ø¥ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±ØŸ',
      'Ø£Ø±ÙŠØ¯ Ø£Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©'
    ];
    
    // First, let's see what products are actually available
    console.log('ğŸ“¦ Available Products in Database:');
    const products = await prisma.product.findMany({
      where: {
        companyId: companyId,
        isActive: true
      },
      include: {
        category: true
      },
      orderBy: {
        createdAt: 'desc'
      }
    });
    
    console.log(`âœ… Found ${products.length} active products:`);
    products.forEach((product, index) => {
      console.log(`   ${index + 1}. ${product.name} - ${product.price} Ø¬Ù†ÙŠÙ‡ (Stock: ${product.stock})`);
    });
    
    // Test how Gemini responds to general questions
    console.log('\nğŸ¤– Testing Gemini Responses to General Questions...');
    
    const AdvancedGeminiService = require('./src/services/advancedGeminiService');
    const advancedGeminiService = new AdvancedGeminiService();
    
    // Initialize Gemini service
    await advancedGeminiService.initialize(companyId);
    
    for (const question of generalQuestions) {
      console.log(`\nâ“ Question: "${question}"`);
      
      try {
        // Build context with available products
        const context = {
          customer: { id: 'test-customer', firstName: 'Ø£Ø­Ù…Ø¯' },
          conversationHistory: [],
          availableProducts: products.slice(0, 5), // Pass top 5 products
          companyInfo: {
            name: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
            totalProducts: products.length
          }
        };
        
        console.log(`ğŸ“Š Context provided: ${context.availableProducts.length} products`);
        
        const response = await advancedGeminiService.generateResponse(companyId, question, context);
        
        if (response.success) {
          console.log(`âœ… Gemini Response:`);
          console.log(`"${response.response}"`);
          
          // Check if response mentions actual products
          let mentionsProducts = false;
          products.forEach(product => {
            if (response.response.includes(product.name)) {
              mentionsProducts = true;
              console.log(`   âœ… Mentions: ${product.name}`);
            }
          });
          
          if (!mentionsProducts) {
            console.log(`   âŒ Response doesn't mention any actual products`);
          }
          
          console.log(`ğŸ“Š Model: ${response.modelUsed}, Confidence: ${response.confidence}`);
          console.log(`â±ï¸ Response Time: ${response.responseTime}ms`);
        } else {
          console.log(`âŒ Gemini failed: ${response.error}`);
          console.log(`ğŸ”„ Fallback: ${response.fallbackResponse}`);
        }
        
      } catch (error) {
        console.error(`âŒ Error with Gemini: ${error.message}`);
      }
      
      console.log('â”€'.repeat(80));
    }
    
    // Test if the issue is with context passing
    console.log('\nğŸ”§ Testing Context Passing...');
    
    const testContext = {
      customer: { id: 'test', firstName: 'Ø£Ø­Ù…Ø¯' },
      conversationHistory: [],
      availableProducts: [
        {
          name: 'ÙƒÙˆØªØ´ÙŠ Ø±ÙŠØ§Ø¶ÙŠ Ù†Ø§ÙŠÙƒ',
          price: 299.99,
          stock: 20,
          description: 'ÙƒÙˆØªØ´ÙŠ Ø±ÙŠØ§Ø¶ÙŠ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©'
        },
        {
          name: 'Ù‡Ø§ØªÙ Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù…',
          price: 2999.99,
          stock: 50,
          description: 'Ù‡Ø§ØªÙ Ø°ÙƒÙŠ Ø¨Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ø§Ù„ÙŠØ©'
        }
      ]
    };
    
    console.log('ğŸ“‹ Test Context:', JSON.stringify(testContext, null, 2));
    
    const testResponse = await advancedGeminiService.generateResponse(
      companyId, 
      'Ø¹Ù†Ø¯ÙƒÙ… Ù…Ù†ØªØ¬Ø§Øª Ø¥ÙŠÙ‡ØŸ', 
      testContext
    );
    
    console.log('\nğŸ§ª Test Response:');
    if (testResponse.success) {
      console.log(`"${testResponse.response}"`);
      
      // Check if it mentions the test products
      const mentionsNike = testResponse.response.includes('Ù†Ø§ÙŠÙƒ');
      const mentionsPhone = testResponse.response.includes('Ù‡Ø§ØªÙ');
      
      console.log(`âœ… Mentions Nike: ${mentionsNike ? 'YES' : 'NO'}`);
      console.log(`âœ… Mentions Phone: ${mentionsPhone ? 'YES' : 'NO'}`);
    } else {
      console.log(`âŒ Failed: ${testResponse.error}`);
    }
    
    console.log('\nğŸ‰ General Questions Test Complete!');
    
  } catch (error) {
    console.error('âŒ Test failed:', error);
  } finally {
    await prisma.$disconnect();
  }
}

testGeminiGeneralQuestions();
