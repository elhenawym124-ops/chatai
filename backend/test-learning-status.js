/**
 * ูุญุต ุญุงูุฉ ูุธุงู ุงูุชุนูู ุงููุณุชูุฑ
 */

const { PrismaClient } = require('@prisma/client');

async function checkLearningSystemStatus() {
  const prisma = new PrismaClient();
  
  console.log('๐ ูุญุต ุญุงูุฉ ูุธุงู ุงูุชุนูู ุงููุณุชูุฑ...\n');

  try {
    // 1. ูุญุต ุงูุฌุฏุงูู
    console.log('๐ ูุญุต ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:');
    
    try {
      const learningDataCount = await prisma.learningData.count();
      console.log(`โ learning_data: ${learningDataCount} ุณุฌู`);
    } catch (error) {
      console.log(`โ learning_data: ุบูุฑ ููุฌูุฏ - ${error.message}`);
    }

    try {
      const patternsCount = await prisma.discoveredPattern.count();
      console.log(`โ discovered_patterns: ${patternsCount} ููุท`);
    } catch (error) {
      console.log(`โ discovered_patterns: ุบูุฑ ููุฌูุฏ - ${error.message}`);
    }

    try {
      const improvementsCount = await prisma.appliedImprovement.count();
      console.log(`โ applied_improvements: ${improvementsCount} ุชุญุณูู`);
    } catch (error) {
      console.log(`โ applied_improvements: ุบูุฑ ููุฌูุฏ - ${error.message}`);
    }

    try {
      const settingsCount = await prisma.learningSettings.count();
      console.log(`โ learning_settings: ${settingsCount} ุฅุนุฏุงุฏ`);
    } catch (error) {
      console.log(`โ learning_settings: ุบูุฑ ููุฌูุฏ - ${error.message}`);
    }

    console.log('');

    // 2. ูุญุต ุงูุฎุฏูุงุช
    console.log('๐ง ูุญุต ุงูุฎุฏูุงุช:');
    
    try {
      const ContinuousLearningServiceV2 = require('./src/services/continuousLearningServiceV2');
      const learningService = new ContinuousLearningServiceV2();
      console.log('โ ContinuousLearningServiceV2: ูุชุงุญ');
      
      // ุงุฎุชุจุงุฑ ุจุณูุท
      const testResult = await learningService.collectLearningData({
        companyId: 'test',
        type: 'test',
        data: { test: true }
      });
      
      if (testResult.success) {
        console.log('โ ุฌูุน ุงูุจูุงูุงุช: ูุนูู');
        
        // ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
        await prisma.learningData.deleteMany({
          where: { companyId: 'test' }
        });
      } else {
        console.log(`โ ุฌูุน ุงูุจูุงูุงุช: ูุดู - ${testResult.error}`);
      }
      
    } catch (error) {
      console.log(`โ ContinuousLearningServiceV2: ุบูุฑ ูุชุงุญ - ${error.message}`);
    }

    try {
      const aiAgentService = require('./src/services/aiAgentService');
      console.log('โ aiAgentService: ูุชุงุญ');
      
      // ูุญุต ุฅุฐุง ูุงู ุงูุชูุงูู ููุฌูุฏ
      if (aiAgentService.collectLearningData) {
        console.log('โ ุชูุงูู ุงูุชุนูู ูุน AI Agent: ููุฌูุฏ');
      } else {
        console.log('โ ุชูุงูู ุงูุชุนูู ูุน AI Agent: ุบูุฑ ููุฌูุฏ');
      }
      
    } catch (error) {
      console.log(`โ aiAgentService: ุบูุฑ ูุชุงุญ - ${error.message}`);
    }

    console.log('');

    // 3. ูุญุต ุงููุณุงุฑุงุช
    console.log('๐ ูุญุต ูุณุงุฑุงุช API:');
    
    try {
      const continuousLearningRoutes = require('./src/routes/continuousLearning');
      console.log('โ ูุณุงุฑุงุช ุงูุชุนูู ุงููุณุชูุฑ: ูุชุงุญุฉ');
    } catch (error) {
      console.log(`โ ูุณุงุฑุงุช ุงูุชุนูู ุงููุณุชูุฑ: ุบูุฑ ูุชุงุญุฉ - ${error.message}`);
    }

    try {
      const continuousLearningController = require('./src/controllers/continuousLearningController');
      console.log('โ ุชุญูู ุงูุชุนูู ุงููุณุชูุฑ: ูุชุงุญ');
    } catch (error) {
      console.log(`โ ุชุญูู ุงูุชุนูู ุงููุณุชูุฑ: ุบูุฑ ูุชุงุญ - ${error.message}`);
    }

    console.log('');

    // 4. ูุญุต ุงูุจูุงูุงุช ุงููุนููุฉ
    console.log('๐ ุงูุจูุงูุงุช ุงูุญุงููุฉ:');
    
    const companyId = 'cmdkj6coz0000uf0cyscco6lr'; // ุงูุดุฑูุฉ ุงูุงูุชุฑุงุถูุฉ
    
    const recentLearningData = await prisma.learningData.findMany({
      where: { companyId },
      orderBy: { createdAt: 'desc' },
      take: 5
    });
    
    console.log(`๐ ุจูุงูุงุช ุงูุชุนูู ุงูุญุฏูุซุฉ: ${recentLearningData.length} ุณุฌู`);
    
    recentLearningData.forEach((record, index) => {
      const data = JSON.parse(record.data);
      console.log(`   ${index + 1}. ${record.type} - ${record.outcome || 'ุบูุฑ ูุญุฏุฏ'} (${new Date(record.createdAt).toLocaleString()})`);
    });

    const patterns = await prisma.discoveredPattern.findMany({
      where: { companyId },
      orderBy: { confidence: 'desc' },
      take: 3
    });
    
    console.log(`\n๐ ุงูุฃููุงุท ุงูููุชุดูุฉ: ${patterns.length} ููุท`);
    patterns.forEach((pattern, index) => {
      console.log(`   ${index + 1}. ${pattern.description} (ุซูุฉ: ${pattern.confidence})`);
    });

    const improvements = await prisma.appliedImprovement.findMany({
      where: { companyId },
      orderBy: { appliedAt: 'desc' },
      take: 3
    });
    
    console.log(`\n๐ง ุงูุชุญุณููุงุช ุงููุทุจูุฉ: ${improvements.length} ุชุญุณูู`);
    improvements.forEach((improvement, index) => {
      console.log(`   ${index + 1}. ${improvement.description} (${improvement.status})`);
    });

    // 5. ุงูุชูุตูุงุช
    console.log('\n๐ก ุงูุชูุตูุงุช:');
    
    if (recentLearningData.length === 0) {
      console.log('โ๏ธ  ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุนูู ุญุฏูุซุฉ - ุชุฃูุฏ ูู ุฃู ุงููุธุงู ูุฌูุน ุงูุจูุงูุงุช');
    } else {
      console.log('โ ุงููุธุงู ูุฌูุน ุงูุจูุงูุงุช ุจูุฌุงุญ');
    }
    
    if (patterns.length === 0) {
      console.log('โ๏ธ  ูุง ุชูุฌุฏ ุฃููุงุท ููุชุดูุฉ - ูุฏ ุชุญุชุงุฌ ููุฒูุฏ ูู ุงูุจูุงูุงุช');
    } else {
      console.log('โ ุงููุธุงู ููุชุดู ุงูุฃููุงุท ุจูุฌุงุญ');
    }
    
    if (improvements.length === 0) {
      console.log('โ๏ธ  ูุง ุชูุฌุฏ ุชุญุณููุงุช ูุทุจูุฉ - ูุนู ุงูุชุญุณููุงุช ุงูุชููุงุฆูุฉ');
    } else {
      console.log('โ ุงููุธุงู ูุทุจู ุงูุชุญุณููุงุช ุจูุฌุงุญ');
    }

    console.log('\n๐ ุงูุชูู ูุญุต ุงููุธุงู!');

  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ูุญุต ุงููุธุงู:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// ุชุดุบูู ุงููุญุต
if (require.main === module) {
  checkLearningSystemStatus().catch(console.error);
}

module.exports = checkLearningSystemStatus;
