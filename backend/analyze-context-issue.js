/**
 * ุชุญููู ูุดููุฉ ููู ุงูุณูุงู ูู ุงููุญุงุฏุซุฉ ุงููุนููุฉ
 * Context Understanding Issue Analysis
 */

const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function analyzeContextIssue() {
  console.log('๐ ุชุญููู ูุดููุฉ ููู ุงูุณูุงู ูู ุงููุญุงุฏุซุฉ ุงููุนููุฉ\n');
  console.log('='.repeat(80));

  // ุงููุญุงุฏุซุฉ ุงููุนููุฉ ูู ุงูุตูุฑุฉ
  const actualConversation = [
    {
      sender: "customer",
      message: "ุนุงูุฒู ุงุนุฑู ุงูุณุนุฑ ูุงู ุ",
      expectedIntent: "price_inquiry",
      context: "ุงูุนููู ูุณุฃู ุนู ุงูุณุนุฑ - ุทูุจ ูุนูููุงุช"
    },
    {
      sender: "system", 
      message: "ุณุนุฑ ุงูููุชุดู ุงูุงุณููุชุด 349 ุฌููู. ุชุญุจ ุชุนุฑูู ูุชููุฑ ููู ุงูู ููุง ููุงุณุงุชูุ ูููุงู ูููู ุชุนุฑูู ููุงู ูุญุงูุธุฉ ุงูู ุนุดุงู ุฃุญุณุจูู ุณุนุฑ ุงูุดุญูุ",
      analysis: "ุฑุฏ ุฌูุฏ - ูุฏู ุงูุณุนุฑ + ุฃุณุฆูุฉ ุชูุฌูููุฉ"
    },
    {
      sender: "customer",
      message: "ุงู ูุง ุฑูุช",
      expectedIntent: "confirmation_for_more_info", 
      actualSystemResponse: "ุฅูุดุงุก ุทูุจ ูุชูุงุตูู ุงูุทูุจ...",
      context: "ุงูุนููู ูุคูุฏ ุฑุบุจุชู ูู ูุนุฑูุฉ ุงููุฒูุฏ ูู ุงููุนูููุงุช (ุงูููุงุณุงุช ูุงูุฃููุงู ูุงูุดุญู)"
    }
  ];

  console.log('\n1๏ธโฃ ุชุญููู ุงููุญุงุฏุซุฉ ุงููุนููุฉ:\n');

  actualConversation.forEach((turn, index) => {
    console.log(`${index + 1}. ${turn.sender === 'customer' ? 'ุงูุนููู' : 'ุงููุธุงู'}: "${turn.message}"`);
    if (turn.context) {
      console.log(`   ๐ ุงูุณูุงู: ${turn.context}`);
    }
    if (turn.expectedIntent) {
      console.log(`   ๐ฏ ุงูููุฉ ุงููุชููุนุฉ: ${turn.expectedIntent}`);
    }
    if (turn.actualSystemResponse) {
      console.log(`   ๐ค ุฑุฏ ุงููุธุงู ุงููุนูู: ${turn.actualSystemResponse}`);
      console.log(`   โ ุงููุดููุฉ: ุงููุธุงู ููู "ุงู ูุง ุฑูุช" ูุชุฃููุฏ ููุทูุจ ุจุฏูุงู ูู ุทูุจ ูุนูููุงุช ุฅุถุงููุฉ`);
    }
    if (turn.analysis) {
      console.log(`   โ ุงูุชุญููู: ${turn.analysis}`);
    }
    console.log('');
  });

  console.log('\n2๏ธโฃ ุชุญููู ุงููุดููุฉ:\n');

  console.log('๐ ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:');
  console.log('   ๐ ุงูุฑุณุงูุฉ: "ุงู ูุง ุฑูุช"');
  console.log('   ๐ฏ ุงููุนูู ุงูุตุญูุญ: "ูุนูุ ุฃุฑูุฏ ูุนุฑูุฉ ุงูููุงุณุงุช ูุงูุฃููุงู ูุงูุดุญู"');
  console.log('   โ ููู ุงููุธุงู: "ูุนูุ ุฃุฑูุฏ ุฅูุดุงุก ุทูุจ"');
  console.log('   ๐จ ุงููุชูุฌุฉ: ุฑุฏ ุบูุฑ ููุงุณุจ ุชูุงูุงู');

  console.log('\n๐ก ุงูุณุจุจ ุงููุญุชูู:');
  console.log('   1. ุงููุธุงู ููุณุฑ "ุงู" ูุชุฃููุฏ ููุทูุจ');
  console.log('   2. ูุง ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุงูุณูุงู ุงูุณุงุจู');
  console.log('   3. ูุญุชุงุฌ ุชุญุณูู ูู ููู ุงูุฑุฏูุฏ ุงููุตูุฑุฉ');

  console.log('\n3๏ธโฃ ุชุญููู ุงุณุชุฎุฏุงู ุงูุฃููุงุท:\n');

  // ุชุญููู ุงูุจูุงูุงุช ุงููุนููุฉ ูู API
  console.log('๐ ุฅุญุตุงุฆูุงุช ุงูุงุณุชุฎุฏุงู ุงููุนููุฉ:');
  console.log('   ๐ฏ ุงูููุท ุงูุฃูู: 4 ูุฑุงุช ุงุณุชุฎุฏุงูุ ูุนุฏู ูุฌุงุญ 50%');
  console.log('   ๐ฏ ุงูููุท ุงูุซุงูู: 3 ูุฑุงุช ุงุณุชุฎุฏุงูุ ูุนุฏู ูุฌุงุญ 66.7%');
  console.log('   ๐ ูุชูุณุท ูุนุฏู ุงููุฌุงุญ: 58%');
  console.log('   โ๏ธ ูุฐุง ุฃูู ูู ุงููุชููุน (ูุฌุจ ุฃู ูููู 80%+)');

  console.log('\n๐ ููุงุฑูุฉ ูุน ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ูู ุงููุงุฌูุฉ:');
  console.log('   ๐ฑ ุงููุงุฌูุฉ ุชุธูุฑ: 95% ูุฌุงุญุ 10 ูุฑุงุช ุงุณุชุฎุฏุงู');
  console.log('   ๐ง API ูุธูุฑ: 58% ูุฌุงุญุ 7 ูุฑุงุช ุงุณุชุฎุฏุงู');
  console.log('   โ ููุงู ุชุถุงุฑุจ ูู ุงูุจูุงูุงุช - ูุญุชุงุฌ ูุฑุงุฌุนุฉ');

  console.log('\n4๏ธโฃ ุงูุญููู ุงูููุชุฑุญุฉ:\n');

  console.log('๐ง ูุญู ูุดููุฉ ููู ุงูุณูุงู:');
  console.log('   1. ุชุญุณูู ุชุญููู ุงูุฑุฏูุฏ ุงููุตูุฑุฉ ูุซู "ุงู ูุง ุฑูุช"');
  console.log('   2. ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุณูุงู ููุฐูุงุก ุงูุงุตุทูุงุนู');
  console.log('   3. ุชุญุณูู ููุทู ุงูุชุดุงู ุงูุชุฃููุฏ');
  console.log('   4. ุฅุถุงูุฉ ุฎุทูุฉ ุชุฃููุฏ ุฅุถุงููุฉ ูุจู ุฅูุดุงุก ุงูุทูุจุงุช');

  console.log('\n๐ ูุญู ุชุถุงุฑุจ ุงูุจูุงูุงุช:');
  console.log('   1. ูุฑุงุฌุนุฉ ุญุณุงุจุงุช ุงูุฃุฏุงุก ูู ุงููุงุฌูุฉ');
  console.log('   2. ุงูุชุฃูุฏ ูู ุชุทุงุจู ุงูุจูุงูุงุช ุจูู API ูุงููุงุฌูุฉ');
  console.log('   3. ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชุชุจุน ููุงุณุชุฎุฏุงู ุงููุนูู');

  console.log('\n๐ฏ ูุชุญุณูู ุงูุฃููุงุท:');
  console.log('   1. ุชุญููู ุณุจุจ ุงูุฎูุงุถ ูุนุฏู ุงููุฌุงุญ ุฅูู 58%');
  console.log('   2. ูุฑุงุฌุนุฉ ุงูุฃููุงุท ุงููุทุจูุฉ ูู ุงูุฑุฏูุฏ ุงููุงุดูุฉ');
  console.log('   3. ุชุญุณูู ุฌูุฏุฉ ุชุทุจูู ุงูุฃููุงุท');
  console.log('   4. ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุฃููุงุท ุงููุชููุนุฉ');

  console.log('\n5๏ธโฃ ุงุฎุชุจุงุฑ ุณุฑูุน ูููู ุงูุณูุงู:\n');

  const contextTests = [
    {
      previousMessage: "ุชุญุจ ุชุนุฑูู ูุชููุฑ ููู ุงูู ููุง ููุงุณุงุชูุ",
      customerResponse: "ุงู ูุง ุฑูุช",
      expectedIntent: "request_more_info",
      currentSystemBehavior: "creates_order",
      correctResponse: "ุงูููุงุณุงุช ุงููุชุงุญุฉ ูู 37 ูุญุฏ 41ุ ูุงูุฃููุงู ูุชููุฑุฉ ุฃุจูุถ ูุฃุณูุฏ ูุจูุฌ. ูู ุฃู ูุญุงูุธุฉ ุนุดุงู ุฃุญุณุจูู ุงูุดุญูุ"
    },
    {
      previousMessage: "ุงูุฅุฌูุงูู 379 ุฌููู. ุชุฃูุฏู ุงูุทูุจุ",
      customerResponse: "ุงู ูุง ุฑูุช", 
      expectedIntent: "confirm_order",
      currentSystemBehavior: "creates_order",
      correctResponse: "ุชู ุชุฃููุฏ ุทูุจู! ุฑูู ุงูุทูุจ: ..."
    }
  ];

  contextTests.forEach((test, index) => {
    console.log(`๐งช ุงุฎุชุจุงุฑ ${index + 1}:`);
    console.log(`   ๐ ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ: "${test.previousMessage}"`);
    console.log(`   ๐ฌ ุฑุฏ ุงูุนููู: "${test.customerResponse}"`);
    console.log(`   ๐ฏ ุงูููุฉ ุงููุชููุนุฉ: ${test.expectedIntent}`);
    console.log(`   ๐ค ุณููู ุงููุธุงู ุงูุญุงูู: ${test.currentSystemBehavior}`);
    console.log(`   โ ุงูุฑุฏ ุงูุตุญูุญ: "${test.correctResponse}"`);
    console.log('');
  });

  console.log('\n6๏ธโฃ ุงูุฎูุงุตุฉ ูุงูุชูุตูุงุช:\n');

  console.log('โ ูุง ูุนูู ุฌูุฏุงู:');
  console.log('   ๐ฏ ุชุทุจูู ุงูุฃููุงุท ูู ุงูุฑุฏูุฏ ุงูุฃูููุฉ');
  console.log('   ๐ ููู ุงูุฃุณุฆูุฉ ุงููุจุงุดุฑุฉ (ุจูุงูุ ุงูููุงุณุงุช ูุงู)');
  console.log('   ๐จ ุงุณุชุฎุฏุงู ุงูููุฌุฉ ุงูููุงุณุจุฉ ูุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ');

  console.log('\nโ ูุง ูุญุชุงุฌ ุฅุตูุงุญ ููุฑู:');
  console.log('   ๐จ ููู ุงูุฑุฏูุฏ ุงููุตูุฑุฉ ูู ุงูุณูุงู');
  console.log('   ๐ ุชุถุงุฑุจ ุจูุงูุงุช ุงูุฃุฏุงุก ุจูู ุงููุงุฌูุฉ ูุงูู API');
  console.log('   ๐ ุงูุฎูุงุถ ูุนุฏู ูุฌุงุญ ุงูุฃููุงุท ุฅูู 58%');

  console.log('\n๐ฏ ุงูุฃููููุงุช:');
  console.log('   1. ุฅุตูุงุญ ูุดููุฉ ููู "ุงู ูุง ุฑูุช" ูู ุงูุณูุงู');
  console.log('   2. ูุฑุงุฌุนุฉ ูุฅุตูุงุญ ุญุณุงุจุงุช ุงูุฃุฏุงุก');
  console.log('   3. ุชุญุณูู ุฌูุฏุฉ ุชุทุจูู ุงูุฃููุงุท');
  console.log('   4. ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงุฎุชุจุงุฑุงุช ุงูุณูุงู');

  console.log('\n' + '='.repeat(80));
  console.log('๐ ุชุงุฑูุฎ ุงูุชุญููู:', new Date().toLocaleString('ar-EG'));
  console.log('๐ ูููุตุญ ุจูุฑุงุฌุนุฉ ููุฏ ุงูุชุดุงู ุงูุชุฃููุฏ ูุชุญุณููู');
  console.log('='.repeat(80));
}

// ุชุดุบูู ุงูุชุญููู
if (require.main === module) {
  analyzeContextIssue().catch(console.error);
}

module.exports = { analyzeContextIssue };
