# 🚀 نظام مفاتيح Gemini المتعددة - التوثيق الشامل

## 📋 نظرة عامة

تم تطوير نظام جديد ومتطور لإدارة مفاتيح Gemini API يدعم:
- **مفتاح واحد لجميع النماذج**: بدلاً من مفتاح منفصل لكل نموذج
- **تتبع منفصل للحصص**: كل نموذج له حصة منفصلة ومراقبة مستقلة
- **تبديل ذكي**: أولاً بين النماذج في نفس المفتاح، ثم بين المفاتيح المختلفة
- **مراقبة في الوقت الفعلي**: عرض شامل لحالة جميع المفاتيح والنماذج

## 🏗️ هيكل قاعدة البيانات

### جدول `gemini_keys` (محدث)
```sql
- id: معرف المفتاح
- name: اسم المفتاح
- apiKey: مفتاح API (فريد)
- model: النموذج الافتراضي (للتوافق مع النظام القديم)
- isActive: هل المفتاح نشط
- priority: أولوية المفتاح (1 = الأعلى)
- description: وصف المفتاح
- usage: بيانات الاستخدام (للتوافق مع النظام القديم)
- createdAt, updatedAt: تواريخ الإنشاء والتحديث
```

### جدول `gemini_key_models` (جديد)
```sql
- id: معرف النموذج
- keyId: معرف المفتاح المرتبط
- model: اسم النموذج
- usage: بيانات الاستخدام (JSON)
- isEnabled: هل النموذج مفعل
- priority: أولوية النموذج (1 = الأعلى)
- lastUsed: آخر استخدام
- createdAt, updatedAt: تواريخ الإنشاء والتحديث
```

## 🎯 النماذج المدعومة وأولوياتها

| الأولوية | النموذج | الحصة الافتراضية | الوصف |
|---------|---------|-----------------|-------|
| 1 | gemini-2.5-flash | 1,000,000 | الأحدث والأفضل - مستقر |
| 2 | gemini-2.5-pro | 500,000 | الأقوى للمهام المعقدة - مستقر |
| 3 | gemini-2.0-flash | 750,000 | سريع ومستقر |
| 4 | gemini-2.0-flash-exp | 1,000 | تجريبي - احتياطي |
| 5 | gemini-1.5-flash | 1,500 | مُهمل لكن يعمل |
| 6 | gemini-1.5-pro | 50 | مُهمل لكن قوي |

## 🔄 منطق التبديل الذكي

### المرحلة الأولى: التبديل بين النماذج في نفس المفتاح
1. البحث عن المفتاح النشط الحالي
2. فحص جميع النماذج المتاحة في هذا المفتاح
3. اختيار أول نموذج متاح حسب الأولوية
4. اختبار صحة النموذج قبل الاستخدام

### المرحلة الثانية: التبديل بين المفاتيح المختلفة
1. البحث في جميع المفاتيح مرتبة حسب الأولوية
2. لكل مفتاح، البحث عن أفضل نموذج متاح
3. تفعيل المفتاح الجديد
4. إرجاع تفاصيل التبديل

## 🛠️ الدوال الرئيسية

### `getActiveGeminiKey()`
- **الوظيفة**: الحصول على مفتاح نشط مع أفضل نموذج متاح
- **الإرجاع**: `{ apiKey, model, keyId, modelId }`

### `findNextAvailableModel()`
- **الوظيفة**: البحث عن نموذج احتياطي متاح
- **الإرجاع**: `{ apiKey, model, keyId, keyName, switchType }`

### `updateModelUsage(modelId)`
- **الوظيفة**: تحديث عداد الاستخدام لنموذج معين
- **المعاملات**: `modelId` - معرف النموذج

### `testModelHealth(apiKey, model)`
- **الوظيفة**: اختبار صحة نموذج معين
- **الإرجاع**: `boolean`

## 📊 API Endpoints الجديدة

### GET `/api/v1/ai/gemini-keys`
عرض جميع المفاتيح مع النماذج والحصص:
```json
{
  "success": true,
  "data": [
    {
      "id": "key-id",
      "name": "اسم المفتاح",
      "apiKey": "AIzaSy...kefU",
      "isActive": true,
      "priority": 1,
      "models": [
        {
          "model": "gemini-2.5-flash",
          "usage": { "used": 0, "limit": 1000000 },
          "isEnabled": true,
          "priority": 1
        }
      ],
      "totalModels": 6,
      "availableModels": 6
    }
  ],
  "summary": {
    "totalKeys": 1,
    "activeKeys": 1,
    "totalModels": 6,
    "availableModels": 6
  }
}
```

### POST `/api/v1/ai/gemini-keys`
إضافة مفتاح جديد (ينشئ جميع النماذج تلقائياً):
```json
{
  "name": "اسم المفتاح",
  "apiKey": "AIzaSy...",
  "description": "وصف اختياري"
}
```

## 🧪 الاختبارات

### اختبار النظام الأساسي
```bash
node test-simple.js
```

### اختبار API
```bash
node test-api.js
```

### اختبار التبديل
```bash
node test-new-system.js
```

## 📈 المزايا الجديدة

### 1. **كفاءة أعلى**
- مفتاح واحد يدعم جميع النماذج
- تقليل عدد المفاتيح المطلوبة
- استغلال أمثل للحصص

### 2. **مرونة أكبر**
- تبديل ذكي بين النماذج
- أولوية قابلة للتخصيص
- مراقبة مفصلة لكل نموذج

### 3. **استقرار محسن**
- اختبار صحة النماذج قبل الاستخدام
- تبديل تلقائي عند الأخطاء
- تتبع دقيق للاستخدام

### 4. **سهولة الإدارة**
- واجهة موحدة لإدارة المفاتيح
- عرض شامل للحالة
- إضافة مبسطة للمفاتيح الجديدة

## 🔧 التكوين والصيانة

### إضافة مفتاح جديد
1. استخدم API endpoint أو واجهة الإدارة
2. سيتم إنشاء جميع النماذج تلقائياً
3. سيتم تعيين الأولوية تلقائياً

### مراقبة الأداء
- فحص `/api/v1/ai/gemini-keys` للحالة العامة
- مراقبة logs للتبديل التلقائي
- تتبع استخدام كل نموذج

### استكشاف الأخطاء
- فحص logs للأخطاء
- اختبار صحة المفاتيح
- التأكد من صحة الحصص

## 🚀 الخطوات التالية

1. **مراقبة الأداء**: تتبع أداء النظام الجديد
2. **تحسين الخوارزميات**: تطوير منطق التبديل
3. **إضافة ميزات**: مثل إعادة تعيين الحصص التلقائية
4. **تحسين الواجهة**: تطوير لوحة تحكم متقدمة

---

**تم التطوير بواسطة**: فريق التطوير  
**التاريخ**: 2025-01-28  
**الإصدار**: 2.0.0
