/**
 * ุฎูุงุฑุงุช Rate Limiting ุงููุฎุชููุฉ
 * ูููู ุชุนุฏูู ูุฐู ุงูุฅุนุฏุงุฏุงุช ุญุณุจ ุงุญุชูุงุฌุงุช ุงููุดุฑูุน
 */

const rateLimit = require('express-rate-limit');

// ========================================
// 1. ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ (ูุดุฏุฏุฉ ููุฃูุงู)
// ========================================
const currentAuthLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 ุฏูููุฉ
  max: 5, // 5 ูุญุงููุงุช ููุท
  message: {
    success: false,
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ููุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 15 ุฏูููุฉ',
    code: 'RATE_LIMIT_EXCEEDED'
  }
});

// ========================================
// 2. ุฅุนุฏุงุฏุงุช ูุชูุณุทุฉ (ููุชุทููุฑ)
// ========================================
const developmentAuthLimit = rateLimit({
  windowMs: 5 * 60 * 1000, // 5 ุฏูุงุฆู
  max: 10, // 10 ูุญุงููุงุช
  message: {
    success: false,
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 5 ุฏูุงุฆู',
    code: 'RATE_LIMIT_EXCEEDED'
  }
});

// ========================================
// 3. ุฅุนุฏุงุฏุงุช ูุฑูุฉ (ููุงุฎุชุจุงุฑ)
// ========================================
const testingAuthLimit = rateLimit({
  windowMs: 1 * 60 * 1000, // ุฏูููุฉ ูุงุญุฏุฉ
  max: 20, // 20 ูุญุงููุฉ
  message: {
    success: false,
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุฏูููุฉ',
    code: 'RATE_LIMIT_EXCEEDED'
  }
});

// ========================================
// 4. ุฅุนุฏุงุฏุงุช ุงูุฅูุชุงุฌ (ููุตู ุจูุง)
// ========================================
const productionAuthLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 ุฏูููุฉ
  max: 3, // 3 ูุญุงููุงุช ููุท (ุฃูุซุฑ ุฃูุงูุงู)
  message: {
    success: false,
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ููุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 15 ุฏูููุฉ',
    code: 'RATE_LIMIT_EXCEEDED'
  },
  standardHeaders: true,
  legacyHeaders: false,
  // ุฅุถุงูุฉ ุชุณุฌูู ูููุญุงููุงุช ุงููุดุจููุฉ
  handler: (req, res) => {
    console.log(`๐จ [RATE-LIMIT] ${req.ip} exceeded auth limit`);
    res.status(429).json({
      success: false,
      message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ููุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 15 ุฏูููุฉ',
      code: 'RATE_LIMIT_EXCEEDED'
    });
  }
});

// ========================================
// 5. ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ (ูุน IP Whitelist)
// ========================================
const advancedAuthLimit = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: (req) => {
    // IPs ููุซููุฉ (ูุซู ููุงุชุจ ุงูุดุฑูุฉ)
    const trustedIPs = ['192.168.1.100', '10.0.0.50'];
    if (trustedIPs.includes(req.ip)) {
      return 50; // ุญุฏ ุฃุนูู ููู IPs ุงูููุซููุฉ
    }
    return 5; // ุงูุญุฏ ุงูุนุงุฏู
  },
  message: {
    success: false,
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ููุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 15 ุฏูููุฉ',
    code: 'RATE_LIMIT_EXCEEDED'
  }
});

// ========================================
// 6. ุฅุนุฏุงุฏุงุช ุฏููุงููููุฉ (ุญุณุจ ุงูุจูุฆุฉ)
// ========================================
const createDynamicAuthLimit = () => {
  const isDevelopment = process.env.NODE_ENV === 'development';
  const isProduction = process.env.NODE_ENV === 'production';
  
  if (isDevelopment) {
    return {
      windowMs: 2 * 60 * 1000, // ุฏูููุชุงู
      max: 15, // 15 ูุญุงููุฉ
      message: 'Rate limit (Development): ุญุงูู ุจุนุฏ ุฏูููุชูู'
    };
  } else if (isProduction) {
    return {
      windowMs: 30 * 60 * 1000, // 30 ุฏูููุฉ
      max: 3, // 3 ูุญุงููุงุช ููุท
      message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 30 ุฏูููุฉ'
    };
  } else {
    return {
      windowMs: 15 * 60 * 1000, // 15 ุฏูููุฉ
      max: 5, // 5 ูุญุงููุงุช
      message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 15 ุฏูููุฉ'
    };
  }
};

// ========================================
// 7. ุฅุนุฏุงุฏุงุช ูุฎุชููุฉ ูู endpoints ูุฎุชููุฉ
// ========================================
const rateLimitConfigs = {
  // ุชุณุฌูู ุงูุฏุฎูู - ูุดุฏุฏ
  login: {
    windowMs: 15 * 60 * 1000,
    max: 5,
    message: 'ุชู ุชุฌุงูุฒ ูุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู'
  },
  
  // ุงูุชุณุฌูู - ุฃูู ุชุดุฏุฏุงู
  register: {
    windowMs: 60 * 60 * 1000, // ุณุงุนุฉ
    max: 3, // 3 ุญุณุงุจุงุช ุฌุฏูุฏุฉ ููุท ูู ุงูุณุงุนุฉ
    message: 'ุชู ุชุฌุงูุฒ ูุญุงููุงุช ุฅูุดุงุก ุงูุญุณุงุจุงุช'
  },
  
  // ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ - ูุชูุณุท
  resetPassword: {
    windowMs: 60 * 60 * 1000, // ุณุงุนุฉ
    max: 5, // 5 ูุญุงููุงุช ูู ุงูุณุงุนุฉ
    message: 'ุชู ุชุฌุงูุฒ ูุญุงููุงุช ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ'
  },
  
  // APIs ุงูุนุงูุฉ - ูุฑู
  general: {
    windowMs: 15 * 60 * 1000,
    max: 100, // 100 ุทูุจ ูู 15 ุฏูููุฉ
    message: 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ููุทูุจุงุช'
  }
};

// ========================================
// ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู
// ========================================
console.log('๐ง ุฎูุงุฑุงุช Rate Limiting ุงููุชุงุญุฉ:');
console.log('1. ุงูุญุงูู (ูุดุฏุฏ): 5 ูุญุงููุงุช / 15 ุฏูููุฉ');
console.log('2. ุงูุชุทููุฑ (ูุชูุณุท): 10 ูุญุงููุงุช / 5 ุฏูุงุฆู');
console.log('3. ุงูุงุฎุชุจุงุฑ (ูุฑู): 20 ูุญุงููุฉ / ุฏูููุฉ');
console.log('4. ุงูุฅูุชุงุฌ (ุขูู): 3 ูุญุงููุงุช / 15 ุฏูููุฉ');
console.log('5. ูุชูุฏู (ูุน IP Whitelist)');
console.log('6. ุฏููุงูููู (ุญุณุจ ุงูุจูุฆุฉ)');

module.exports = {
  currentAuthLimit,
  developmentAuthLimit,
  testingAuthLimit,
  productionAuthLimit,
  advancedAuthLimit,
  createDynamicAuthLimit,
  rateLimitConfigs
};
