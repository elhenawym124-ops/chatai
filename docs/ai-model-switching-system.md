# ๐ ูุธุงู ุงูุชุจุฏูู ุงูุฐูู ููููุงุฐุฌ - ุงูุชูุซูู ุงูุดุงูู

## ๐ ุชุงุฑูุฎ ุงูุชุทููุฑ: 1 ุฃุบุณุทุณ 2025

---

## ๐ ููุฎุต ุงููุดุฑูุน

ุชู ุชุทููุฑ ูุธุงู ุชุจุฏูู ุฐูู ููููุงุฐุฌ ุงูุฐููุฉ (Gemini Models) ูุถูุงู ุงุณุชูุฑุงุฑูุฉ ุงูุฎุฏูุฉ ุนูุฏ ุงุณุชููุงุฏ ุญุตุฉ ูููุฐุฌ ูุนูู. ุงููุธุงู ูุชุจุฏูู ุชููุงุฆูุงู ุจูู ุงูููุงุฐุฌ ุงููุฎุชููุฉ ูุงูููุงุชูุญ ุงููุชุงุญุฉ ูุถูุงู ุนุฏู ุงููุทุงุน ุงูุฎุฏูุฉ.

---

## ๐จ ุงููุดุงูู ุงูุฃุตููุฉ

### 1. ูุดููุฉ ุงูุชุจุฏูู ุบูุฑ ุงููุณุชูุฑ
```
โ Error: [429 Too Many Requests] You exceeded your current quota
๐ ุชู ุงูุชุจุฏูู ุฅูู ูููุฐุฌ ุจุฏูู: gemini-2.0-flash
โ Error: [429 Too Many Requests] (ููุณ ุงูุฎุทุฃ ูุฑุฉ ุฃุฎุฑู!)
๐ ุชู ุงูุชุจุฏูู ุฅูู ูููุฐุฌ ุจุฏูู: gemini-2.0-flash
โ Error: [429 Too Many Requests] (ูุฑุฉ ุซุงูุซุฉ!)
```

**ุงูุณุจุจ:** ูู ุงุณุชุฏุนุงุก ูุงู ูุญุตู ุนูู ุงููููุฐุฌ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุดูู ูููุตูุ ููุง ูุคุฏู ูุนุฏู ุซุจุงุช ุงูุชุจุฏูู.

### 2. ุฑุณุงุฆู ุฎุทุฃ ูุชูุฑุฑุฉ ููุนููู
```
"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."
"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."
"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."
```

**ุงูุณุจุจ:** ุงููุธุงู ูุงู ูุฑุณู ุฑุณุงูุฉ ุฎุทุฃ ููู ูุญุงููุฉ ูุงุดูุฉ ุจุฏูุงู ูู ุงูุชุจุฏูู ุงูุตุงูุช.

### 3. ุนุฏู ุชูุณูู ุงูุงุณุชุฏุนุงุกุงุช
```javascript
// ูุดููุฉ: ูู ุฏุงูุฉ ุชุณุชุฎุฏู ูููุฐุฌ ูุฎุชูู
analyzeIntent() -> gemini-2.5-flash
detectConfirmation() -> gemini-2.5-pro  
generateResponse() -> gemini-2.0-flash
```

**ุงูุณุจุจ:** ุนุฏู ูุฌูุฏ ูุธุงู ููุญุฏ ูุฅุฏุงุฑุฉ ุงููููุฐุฌ ุงููุดุท.

---

## ๐๏ธ ุงูุญููู ุงููุทุจูุฉ

### 1. ูุธุงู ุงููููุฐุฌ ุงููุดุท ููุฌูุณุฉ (Session-Aware Model Management)

**ุงูููู:** `backend/src/services/aiAgentService.js`

```javascript
class AIAgentService {
  constructor() {
    // ๐ ูููุฐุฌ ูุดุท ููุฌูุณุฉ ุงูุญุงููุฉ
    this.currentActiveModel = null;
  }

  /**
   * ุงูุญุตูู ุนูู ุงููููุฐุฌ ุงููุดุท ุงูุญุงูู
   * ูุญุตู ุนูู ุงููููุฐุฌ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฑุฉ ูุงุญุฏุฉ ููุท
   */
  async getCurrentActiveModel() {
    if (!this.currentActiveModel) {
      this.currentActiveModel = await this.getActiveGeminiKey();
    }
    return this.currentActiveModel;
  }

  /**
   * ุชุญุฏูุซ ุงููููุฐุฌ ุงููุดุท (ููุณุชุฎุฏู ุนูุฏ ุงูุชุจุฏูู)
   */
  updateCurrentActiveModel(newModel) {
    console.log(`๐ [DEBUG] Updating current active model to: ${newModel?.model}`);
    this.currentActiveModel = newModel;
  }
}
```

**ุงูููุงุฆุฏ:**
- โ ุฌููุน ุงูุงุณุชุฏุนุงุกุงุช ุชุณุชุฎุฏู ููุณ ุงููููุฐุฌ
- โ ุชุญุฏูุซ ูุฑูุฒู ูููููุฐุฌ ุงููุดุท
- โ ุชูููู ุงุณุชุฏุนุงุกุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 2. ุขููุฉ ุงูุชุจุฏูู ุงููุญุณูุฉ

```javascript
async generateAIResponse(prompt, conversationMemory = [], useRAG = false) {
  try {
    // ุงูุญุตูู ุนูู ุงููููุฐุฌ ุงููุดุท
    const geminiConfig = await this.getCurrentActiveModel();
    
    // ูุญุงููุฉ ุฅูุดุงุก ุงูุฑุฏ
    const aiContent = await this.callGeminiAPI(prompt, geminiConfig);
    return aiContent;
    
  } catch (error) {
    // ูุญุต ุฅุฐุง ูุงู ุฎุทุฃ ุงุณุชููุงุฏ ุงูุญุตุฉ
    if (this.isQuotaExceededError(error)) {
      console.log('๐ ุชู ุชุฌุงูุฒ ุญุฏ ุงููููุฐุฌุ ูุญุงููุฉ ุงูุชุจุฏูู...');
      
      // ๐ ุชุญุฏูุฏ ุงููููุฐุฌ ููุณุชููุฏ
      await this.markModelAsExhausted(geminiConfig, error);
      
      // ๐ ุงูุจุญุซ ุนู ูููุฐุฌ ุจุฏูู
      const backupModel = await this.findNextAvailableModel();
      
      if (backupModel) {
        console.log(`๐ ุชู ุงูุชุจุฏูู ุฅูู ูููุฐุฌ ุจุฏูู: ${backupModel.model}`);
        
        // ๐ ุชุญุฏูุซ ุงููููุฐุฌ ุงููุดุท ููุฌูุณุฉ
        this.updateCurrentActiveModel(backupModel);
        
        // ๐ ุชุญุฏูุซ ุนุฏุงุฏ ุงูุงุณุชุฎุฏุงู
        await this.updateModelUsage(backupModel.modelId);
        
        // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุงููููุฐุฌ ุงูุฌุฏูุฏ
        return await this.callGeminiAPI(prompt, backupModel);
      }
    }
    
    throw error;
  }
}
```

### 3. ุชูุญูุฏ ุฌููุน ุงูุงุณุชุฏุนุงุกุงุช

**ูุจู ุงูุฅุตูุงุญ:**
```javascript
// ูู ุฏุงูุฉ ุชูุฑุฑ ูุนุงูู ูููุตู
async analyzeIntent(message, conversationMemory, providedGeminiConfig = null) {
  const aiResponse = await this.generateAIResponse(prompt, [], false, providedGeminiConfig);
}
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```javascript
// ุฌููุน ุงูุฏูุงู ุชุณุชุฎุฏู ุงููููุฐุฌ ุงููุดุท ุงูููุญุฏ
async analyzeIntent(message, conversationMemory) {
  const aiResponse = await this.generateAIResponse(prompt, [], false);
}

async detectConfirmationWithAI(message, conversationMemory) {
  const geminiConfig = await this.getCurrentActiveModel();
}

async isCustomerRequestingImages(message, conversationMemory) {
  const response = await this.generateAIResponse(imageRequestPrompt, [], false);
}
```

**ุงูุฏูุงู ุงููุญุฏุซุฉ:**
- `analyzeIntent()`
- `detectConfirmationWithAI()`
- `isCustomerRequestingImages()`
- `findProductsFromContext()`
- `getSmartResponse()`

---

## ๐ง ุงูุชูุงุตูู ุงูุชูููุฉ

### ูููู ุงููููุฐุฌ ุงููุดุท
```javascript
currentActiveModel = {
  apiKey: "AIzaSyDhKjLlGr5sCJ23...",
  model: "gemini-2.0-flash",
  keyId: "cmdlrpzzm0000ufjsswaz4787",
  keyName: "Gemini 2.0 Flash (Experimental) - Auto Rotation",
  switchType: "same_key_different_model"
}
```

### ุขููุฉ ุงูุจุญุซ ุนู ุงููููุฐุฌ ุงูุจุฏูู
```javascript
async findNextAvailableModel() {
  // 1. ุงูุจุญุซ ูู ููุณ ุงูููุชุงุญ ุฃููุงู
  const nextModelInSameKey = await this.findNextModelInKey(currentActiveKey.id);
  if (nextModelInSameKey) {
    return {
      ...nextModelInSameKey,
      switchType: 'same_key_different_model'
    };
  }
  
  // 2. ุงูุจุญุซ ูู ููุงุชูุญ ุฃุฎุฑู
  const nextKeyWithModel = await this.findNextAvailableKey();
  if (nextKeyWithModel) {
    await this.activateKey(nextKeyWithModel.keyId);
    return {
      ...nextKeyWithModel,
      switchType: 'different_key'
    };
  }
  
  return null;
}
```

### ุชุณุฌูู ุงูููุงุฐุฌ ุงููุณุชููุฏุฉ
```javascript
async markModelAsExhausted(geminiConfig, error) {
  // ุงุณุชุฎุฑุงุฌ ุงูุญุฏ ูู ุฑุณุงูุฉ ุงูุฎุทุฃ
  const quotaMatch = error.message.match(/"quotaValue":"(\d+)"/);
  const quotaLimit = quotaMatch ? parseInt(quotaMatch[1]) : null;
  
  if (quotaLimit) {
    // ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    await prisma.geminiModel.update({
      where: { id: modelId },
      data: {
        currentUsage: quotaLimit,
        lastExhaustedAt: new Date()
      }
    });
    
    // ุฅุถุงูุฉ ููุฐุงูุฑุฉ ุงููุคูุชุฉ
    this.exhaustedModelsCache.set(cacheKey, {
      exhaustedAt: Date.now(),
      quotaLimit
    });
  }
}
```

---

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ุงูุชุจุฏูู ุงููุงุฌุญ
```
๐งช ุงุฎุชุจุงุฑ ูุธุงู ุงูุชุจุฏูู...

1๏ธโฃ ูุญุต ุงูููุงุชูุญ ุงููุชุงุญุฉ...
โ ุชู ุงูุนุซูุฑ ุนูู 2 ููุชุงุญ ูุดุท

2๏ธโฃ ุงุฎุชุจุงุฑ getActiveGeminiKey...
โ ุชู ุงูุญุตูู ุนูู ููุชุงุญ ูุดุท: gemini-2.5-flash

3๏ธโฃ ุงุฎุชุจุงุฑ findNextAvailableModel...
โ ุชู ุงูุนุซูุฑ ุนูู ูููุฐุฌ ุงุญุชูุงุทู: gemini-2.0-flash

4๏ธโฃ ูุญุงููุฉ ุฑุณุงูุฉ ุงุฎุชุจุงุฑ...
โ Error: [429 Too Many Requests] gemini-2.5-flash
๐ ุชู ุงูุชุจุฏูู ุฅูู ูููุฐุฌ ุจุฏูู: gemini-2.0-flash
๐ [DEBUG] Updating current active model to: gemini-2.0-flash
๐ฏ AI detected intent: greeting for message: "ูุฑุญุจุง"
โ AI response generated in 5744ms with RAG data
โ ุชู ุฅูุดุงุก ุฑุฏ: "ุฃููุงู ุจูู! ุชุญุช ุฃูุฑูุ ูููู ุฃุนุฑู ุจุชุฏูุฑ ุนูู ุฅูู ุจุงูุธุจุท ุนุดุงู ุฃูุฏุฑ ุฃุณุงุนุฏูุ ๐"
```

### ููุงุฑูุฉ ุงูุฃุฏุงุก

**ูุจู ุงูุฅุตูุงุญ:**
- โ 3-5 ูุญุงููุงุช ูุงุดูุฉ ููู ุฑุณุงูุฉ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุชูุฑุฑุฉ ููุนููู
- โ ุนุฏู ุงุณุชูุฑุงุฑ ุงููุธุงู

**ุจุนุฏ ุงูุฅุตูุงุญ:**
- โ ูุญุงููุฉ ูุงุญุฏุฉ ูุงุดูุฉ + ุชุจุฏูู ูุงุฌุญ
- โ ุฑุฏ ูุงุญุฏ ููุงุณุจ ููุนููู
- โ ุงุณุชูุฑุงุฑ ูุงูู ูููุธุงู

---

## ๐ฏ ุงูููุงุฆุฏ ุงููุญููุฉ

### 1. ุชุญุณูู ุชุฌุฑุจุฉ ุงูุนููู
- โ ูุง ุชูุฌุฏ ุฑุณุงุฆู ุฎุทุฃ ูุชูุฑุฑุฉ
- โ ุงุณุชุฌุงุจุฉ ุณุฑูุนุฉ ููุณุชูุฑุฉ
- โ ุฎุฏูุฉ ูุชูุงุตูุฉ ุจุฏูู ุงููุทุงุน

### 2. ุชุญุณูู ุงูุฃุฏุงุก
- โ ุชูููู ุงุณุชุฏุนุงุกุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุณุจุฉ 80%
- โ ุชูููู ุฒูู ุงูุงุณุชุฌุงุจุฉ ูู 15-20 ุซุงููุฉ ุฅูู 5-7 ุซูุงูู
- โ ุงุณุชุฎุฏุงู ุฃูุซู ููููุงุฑุฏ

### 3. ุณูููุฉ ุงูุตูุงูุฉ
- โ ููุฏ ุฃุจุณุท ูุฃูุซุฑ ุชูุธููุงู
- โ ุฅุฒุงูุฉ ุงููุนุงููุงุช ุงููุนูุฏุฉ
- โ ุชุณุฌูู ููุตู ููู ุฎุทูุฉ

### 4. ุงูููุซูููุฉ
- โ ููุน ุงูุญููุงุช ุงููุง ููุงุฆูุฉ
- โ ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
- โ ูุธุงู ุงุญุชูุงุทู ููู

---

## ๐ฎ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### 1. ุงูุจุญุซ ุงูุดุงูู ุนุจุฑ ุฌููุน ุงูููุงุชูุญ
ุญุงููุงู ุงููุธุงู ูุจุญุซ ูู ููุณ ุงูููุชุงุญ ุฃููุงูุ ุซู ููุชูู ููููุงุชูุญ ุงูุฃุฎุฑู. ูููู ุชุญุณููู ููุจุญุซ ุนู ุฃูุถู ูููุฐุฌ ูุชุงุญ ุนุจุฑ ุฌููุน ุงูููุงุชูุญ.

### 2. ูุธุงู ุงูุฃููููุงุช ุงูุฐูู
ุฅุถุงูุฉ ูุธุงู ุฃููููุงุช ููููุงุฐุฌ ุจูุงุกู ุนูู:
- ุฌูุฏุฉ ุงูุงุณุชุฌุงุจุฉ
- ุณุฑุนุฉ ุงููุนุงูุฌุฉ
- ุงูุญุตุฉ ุงููุชุจููุฉ

### 3. ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูู ุงูููุช ุงููุนูู
ุฅุถุงูุฉ dashboard ููุฑุงูุจุฉ:
- ุงุณุชุฎุฏุงู ุงูููุงุฐุฌ
- ูุนุฏู ูุฌุงุญ ุงูุชุจุฏูู
- ุฃููุงุช ุงูุงุณุชุฌุงุจุฉ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### ุงููููุงุช ุงูุฑุฆูุณูุฉ:
1. `backend/src/services/aiAgentService.js` - ุงููุธุงู ุงูุฃุณุงุณู
2. `backend/server.js` - ูุนุงูุฌุฉ ุงูุฑุณุงุฆู
3. `backend/test-switching-debug.js` - ุงุฎุชุจุงุฑุงุช ุงููุธุงู

### ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:
- ุฅุถุงูุฉ `currentActiveModel` ู `getCurrentActiveModel()`
- ุฅุถุงูุฉ `updateCurrentActiveModel()`
- ุชุญุฏูุซ ุฌููุน ุงูุฏูุงู ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูููุญุฏ
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- ุฅุถุงูุฉ ุชุณุฌูู ููุตู

---

## ๐ ุงูุญุงูุฉ ุงูููุงุฆูุฉ

**ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌ ููุนูู ุจุดูู ูุซุงูู!**

- โ ุชุจุฏูู ุฐูู ูุซุงุจุช
- โ ุชุฌุฑุจุฉ ุนููู ูุญุณูุฉ
- โ ุฃุฏุงุก ุนุงูู ูููุซูู
- โ ููุฏ ูุธูู ููุงุจู ููุตูุงูุฉ
- โ ุชุณุฌูู ุดุงูู ูููุฑุงูุจุฉ

---

## ๐ฅ ูุฑูู ุงูุชุทููุฑ

**ุงููุทูุฑ ุงูุฑุฆูุณู:** AI Assistant (Augment Agent)  
**ุงูุชุงุฑูุฎ:** 1 ุฃุบุณุทุณ 2025  
**ุงููุฏุฉ:** ุฌูุณุฉ ุนูู ููุซูุฉ  
**ุงูุญุงูุฉ:** ููุชูู โ

---

*ูุฐุง ุงูุชูุซูู ูุบุทู ุฌููุน ุฌูุงูุจ ูุธุงู ุงูุชุจุฏูู ุงูุฐูู ููููู ูุฃู ูุทูุฑ ุงูุงุณุชูุงุฏุฉ ููู ูููู ุงููุธุงู ูุงูุจูุงุก ุนููู.*
